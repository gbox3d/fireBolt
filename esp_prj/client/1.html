<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title></title>

    <script src="./libs/jquery-2.0.3.min.js" ></script>

    <style>

        .frame {
            margin-top: 20px;
            border: 1px solid black;
            padding: 5px;
            background-color: #eec981;
        }

    </style>

</head>
<body>

<div>

    <div id="wifi-info" class="frame">
        target ip : <input class="ip">
    </div>

    <div id="wnd-setup" class="frame">
        <div style="margin-top: 3px">
            <span> ip: <input class="ip"></span>
            <span> net mask: <input class="netmask"></span>
            <span> gate way: <input class="gateway"></span>
        </div>
        <div style="margin-top: 3px">
            <span>ssid: <input class="ssid"></span>
            <span>passwd: <input class="passwd"></span>
        </div>
        <div style="margin-top: 3px">
            <button class="save"> save </button>
        </div>

    </div>

    <div id="compiler" class="frame">
        <div>
            <span>file name : <input class="file-name"></span>
        </div>
        <button class="compile"> compile </button>
    </div>

    <div id="admin-cmd" class="frame">
        <button class="reboot"> restart </button>
    </div>


</div>

<div id="wnd-log">

</div>


<script>

    if(localStorage.cuurent_ip) {
        document.querySelector('#wifi-info input.ip').value = localStorage.cuurent_ip;
    }
    else {
        localStorage.cuurent_ip = document.querySelector('#wifi-info input.ip').value = '192.168.9.108';
    }

    document.querySelector('#wifi-info input.ip').addEventListener('input',function(evt) {

        localStorage.cuurent_ip = evt.target.value;
    })

    if(localStorage.ip == undefined) {

        document.querySelector('#wnd-setup input.ip').value = '192.168.9.108';
        document.querySelector('#wnd-setup input.netmask').value = '255.255.255.0';
        document.querySelector('#wnd-setup input.gateway').value = '192.168.9.177';

        document.querySelector('#wnd-setup input.ssid').value = 'GUNPOWER_PI_1';
        document.querySelector('#wnd-setup input.passwd').value = '';

    }
    else {

        document.querySelector('#wnd-setup input.ip').value = localStorage.ip ;
        document.querySelector('#wnd-setup input.netmask').value = localStorage.netmask;
        document.querySelector('#wnd-setup input.gateway').value = localStorage.gateway;

        document.querySelector('#wnd-setup input.ssid').value = localStorage.ssid;
        document.querySelector('#wnd-setup input.passwd').value = localStorage.passwd;

    }


    if(localStorage.file_to_compile) {
        document.querySelector('#compiler input.file-name').value = localStorage.file_to_compile;
    }
    else {
        document.querySelector('#compiler input.file-name').value = 'wifi_config.lua';
    }



    function add_log(msg) {

        var dom_log = document.querySelector('#wnd-log');

        var text = document.createElement('div');
        text.innerText = msg;
        dom_log.appendChild(text);

    }

    document.querySelector('#wnd-setup button.save').addEventListener('click',function() {

        localStorage.ip = document.querySelector('#wnd-setup input.ip').value;
        localStorage.netmask = document.querySelector('#wnd-setup input.netmask').value;
        localStorage.gateway = document.querySelector('#wnd-setup input.gateway').value;


        localStorage.ssid = document.querySelector('#wnd-setup input.ssid').value;
        localStorage.passwd = document.querySelector('#wnd-setup input.passwd').value;

        var config_file = {
            name : 'wifi_config.lua',
            content : [
                'wifi.setmode(wifi.STATION)',
                'cfg = {',
                'ip = "' + localStorage.ip +'",',
                'netmask = "'+ localStorage.netmask +'",',
                'gateway="'+ localStorage.gateway +'"',
                '}',
                'wifi.sta.setip(cfg)',
                'wifi.sta.connect()',
                'wifi.sta.config("'+ localStorage.ssid + '","'+ localStorage.passwd +'")'
            ]
        }

        console.log(config_file);

        var cuurent_url = document.querySelector('#wifi-info input.ip').value;

        $.ajax({

            url : 'http://'+ cuurent_url +'/file-save',
            type:'GET',
            dataType : 'text',
            timeout : 3000,
            data : {kunio : JSON.stringify(config_file)},
            success : function(data,text,xhr) {

                console.log(data);

                add_log('config file save success')


            },
            error : function(xhr,text,err) {

            },
            complete : function(xhr,text) {

            }

        });


    })

    document.querySelector('#compiler button.compile').addEventListener('click',function() {

        var cuurent_url = document.querySelector('#wifi-info input.ip').value;

        localStorage.file_to_compile = document.querySelector('#compiler input.file-name').value


        var option_data = {
            name : localStorage.file_to_compile
        }


        $.ajax({

            url : 'http://'+ cuurent_url +'/compile',
            type:'GET',
            dataType : 'text',
            timeout : 3000,
            data : {kunio : JSON.stringify(option_data)},
            success : function(data,text,xhr) {

                console.log(data);

                add_log( localStorage.file_to_compile + 'compile success')

            },
            error : function(xhr,text,err) {

            },
            complete : function(xhr,text) {

            }

        });


    })

    document.querySelector('#admin-cmd button.reboot').addEventListener('click',function() {

        var cuurent_url = document.querySelector('#wifi-info input.ip').value;

        var option_data = {
            cmd : 'reboot'
        }

        $.ajax({

            url: 'http://' + cuurent_url + '/restart',
            type: 'GET',
            dataType: 'text',
            timeout: 3000,
            data: {kunio: JSON.stringify(option_data)},
            success: function (data, text, xhr) {

                console.log(data);

                add_log('reboot now!')

            },
            error: function (xhr, text, err) {

            },
            complete: function (xhr, text) {

            }

        });
    })

</script>


</body>
</html>