<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title> wifi config(mini)0.1.0 </title>

    <script src="libs/extra/async.js"></script>
    <script src="libs/jquery-2.0.3.min.js" ></script>

    <style>

        .frame {
            margin-top: 20px;
            border: 1px solid black;
            padding: 5px;
            background-color: #eec981;
        }

        #admin-cmd div span {
            width: 100px;
            display: inline-block;
        }

    </style>

</head>
<body>

<div>

    <div id="wifi-info" class="frame">
        current ip : <input class="ip">

        <div style="margin: inherit;">
            <span style="margin-right: 5px;" >start ip :<input class="search-start" style="height: 32px;width: 64px;font-size: 18px;"></span>
            <button style="width: 80px;height: 32px;margin: auto;" class="scan" >scan</button><span class="text"></span>
        </div>

        <ul class="device-list">

        </ul>

    </div>

    <div id="wnd-setup" class="frame">
        <div style="margin-top: 3px">
            <span> ip: <input class="ip"></span>
        </div>
        <div style="margin-top: 3px">
            <span>ssid: <input class="ssid"></span>
            <span>passwd: <input class="passwd"></span>
        </div>
        <div style="margin-top: 3px">
            <button class="save"> save </button>
        </div>

    </div>

    <div id="admin-cmd" class="frame">

        <div class="reboot" style="height: 32px;" >
            <button > restart </button>
        </div>

        <div class="ping" style="height: 32px;" >
            <button > ping </button>
        </div>

        <div class="upgrade" style="height: 32px;" >
            <button > upgrade </button>
        </div>

    </div>



</div>

<div id="wnd-log">

</div>


<script>

    var theApp = {
        //broker_ip : "192.168.9.177:1480"
        broker_ip : "localhost:1480"
    }

    function restoreFormlocalStageALL() {

        function _restore(input_component,storage_key,default_value) {

            var storage_value = localStorage[storage_key]

            if(storage_value) {
                input_component.value = storage_value;
            }
            else {
                storage_value = input_component.value = default_value;
            }

            input_component.addEventListener('input',function(evt) {

                storage_value = evt.target.value;
                localStorage[storage_key] = storage_value;
            })

            localStorage[storage_key] = storage_value;

        }

        _restore(document.querySelector('#wifi-info input.ip'),'target_ip','192.168.9.20')
        //_restore(document.querySelector('#wifi-info input.central-ip'),'central_ip','192.168.9.180')
        //_restore(document.querySelector('#wifi-info input.bro-ip'),'broker_ip','192.168.9.177:1480')

    }

    restoreFormlocalStageALL()


    if(localStorage.ip == undefined) {

        document.querySelector('#wnd-setup input.ip').value = '192.168.9.20';
        document.querySelector('#wnd-setup input.ssid').value = 'GUNPOWER_PI_1';
        document.querySelector('#wnd-setup input.passwd').value = '';

        document.querySelector('#wifi-info input.search-start').value = 20;

    }
    else {

        document.querySelector('#wnd-setup input.ip').value = localStorage.ip ;
        document.querySelector('#wnd-setup input.ssid').value = localStorage.ssid;
        document.querySelector('#wnd-setup input.passwd').value = localStorage.passwd;

        document.querySelector('#wifi-info input.search-start').value = localStorage.start_ip;

    }



    function add_log(msg) {

        var dom_log = document.querySelector('#wnd-log');
        var text = document.createElement('div');
        text.innerText = msg;
        dom_log.appendChild(text);

        setTimeout(function() {
            dom_log.removeChild(text);
        },1000);
    }

    document.querySelector('#wnd-setup button.save').addEventListener('click',function() {

        var target_ip = document.querySelector('#wifi-info input.ip').value;
        var cuurent_url = theApp.broker_ip;

        localStorage.ip = document.querySelector('#wnd-setup input.ip').value;
        //localStorage.netmask = document.querySelector('#wnd-setup input.netmask').value;
        //localStorage.gateway = document.querySelector('#wnd-setup input.gateway').value;

        var netmask = '255.255.255.0';
        var gateway = '';


        localStorage.ssid = document.querySelector('#wnd-setup input.ssid').value;
        localStorage.passwd = document.querySelector('#wnd-setup input.passwd').value;

        var udp_requst = {
            address :target_ip,
            port : 1471,
            timeout : 1500,
            packet : {
                id : (new Date()).getTime() + '__',
                cmd:'save',
                name:'wifi_setup.lua',
                content : 'wifi.sleeptype(wifi.NONE_SLEEP)wifi.setmode(wifi.STATION) cfg = {ip = "'  + localStorage.ip  +
                '",netmask = "' + netmask +
                '",gateway="'+ gateway +
                '"}wifi.sta.setip(cfg)' +
                'my_ssid="' + localStorage.ssid + '";'+
                'wifi.sta.config(my_ssid,"' + localStorage.passwd  + '")' +
                "wifi.sta.connect()"
            }
        }

        console.log(udp_requst);

        $.ajax({
            url : 'http://'+ cuurent_url +'/send',
            type:'POST',
            dataType : 'text',
            timeout : 5000,
            data : JSON.stringify( udp_requst),
            success : function(data,text,xhr) {

                console.log(data);

                var json_data = JSON.parse(data);

                if(json_data.result == 'ok') {
                    add_log('config file save success')
                }
                else {

                    add_log(json_data.result);
                }




            },
            error : function(xhr,text,err) {

            },
            complete : function(xhr,text) {

            }

        });
    });


    document.querySelector('#admin-cmd .reboot button').addEventListener('click',function() {

        var cuurent_url = theApp.broker_ip;
        var target_ip = document.querySelector('#wifi-info input.ip').value;

        var udp_requst = {
            address :target_ip,
            port : 1471,
            timeout : 1500,
            packet : {
                id : (new Date()).getTime() + '__',
                cmd:'reboot'
            }
        }
        console.log(udp_requst);

        $.ajax({

            url : 'http://'+ cuurent_url +'/send',
            type:'POST',
            dataType : 'text',
            timeout : 3000,
            data : JSON.stringify( udp_requst),
            success : function(data,text,xhr) {

                console.log(data);

                var json_data = JSON.parse(data);

                if(json_data.result == 'ok') {
                    add_log('reboot cmd send success')
                }
                else {

                    add_log(json_data.result);
                }
            },
            error : function(xhr,text,err) {

            },
            complete : function(xhr,text) {

            }

        });
    });


    function sendPing(option) {

        var cuurent_url = option.ip.broker;//theApp.broker_ip;
        var target_ip = option.ip.target;//document.querySelector('#wifi-info input.ip').value;

        var timeout = 1500;
        if(option.timeout != undefined) {
            timeout = option.timeout;
        }


        var udp_requst = {
            address :target_ip,
            port : 1471,
            timeout : timeout,
            packet : {
                id : (new Date()).getTime() + '__',
                cmd:'ping'
            }
        }
        console.log(udp_requst);

        $.ajax({
            url : 'http://'+ cuurent_url +'/send',
            type:'POST',
            dataType : 'text',
            timeout : 3000,
            data : JSON.stringify( udp_requst),
            success : function(data,text,xhr) {

                console.log(data);

                option.callback.success(data);


            },
            error : function(xhr,text,err) {

                option.callback.error(err);

            },
            complete : function(xhr,text) {

            }
        });

    }

    document.querySelector('#admin-cmd .ping button').addEventListener('click',function() {

        sendPing({
           ip : {
               broker : theApp.broker_ip,
               target : document.querySelector('#wifi-info input.ip').value
           },
            callback : {
                success : function(data) {

                    var json_data = JSON.parse(data);

                    if(json_data.result == 'ok') {
                        add_log('ping cmd send success')
                    }
                    else {

                        add_log(json_data.result);
                    }
                },
                error : function(err) {

                }
            }
        });


    });

    document.querySelector('#admin-cmd .upgrade button').addEventListener('click',function() {

        var target_ip = document.querySelector('#wifi-info input.ip').value;
        var cuurent_url = theApp.broker_ip;

        localStorage.ip = document.querySelector('#wnd-setup input.ip').value;
        localStorage.ssid = document.querySelector('#wnd-setup input.ssid').value;
        localStorage.passwd = document.querySelector('#wnd-setup input.passwd').value;

        function _upload(option) {

            var udp_requst = {
                address :target_ip,
                port : 1471,
                timeout : 5000,
                packet : {
                    id : (new Date()).getTime() + '__',
                    cmd:'save',
                    name:option.filename,
                    content : option.content
                }
            }

            console.log(udp_requst);

            $.ajax({

                url : 'http://'+ cuurent_url +'/send',
                type:'POST',
                dataType : 'text',
                timeout : 5000,
                data : JSON.stringify( udp_requst),
                success : function(data,text,xhr) {

                    console.log(data);

                    option.callback.success(data);

                    /*
                    var json_data = JSON.parse(data);

                    if(json_data.result == 'ok') {
                        add_log('app.lua file save success')
                    }
                    else {

                        add_log(json_data.result);
                    }*/
                },
                error : function(xhr,text,err) {
                    option.callback.error(err);

                },
                complete : function(xhr,text) {
                   // option.callback.complete(data);
                }

            });
        }

        async.waterfall([

                function(next) {

                    _upload({

                        filename : 'init.lua',
                        content : "print('u2t0,1.0')dofile('gpio.lua')dofile('wifi_setup.lua')dofile('u2u.lua')function startup()gpio.write(pin_ap_led,gpio.HIGH)gpio.write(pin_connection_led,gpio.LOW)if gpio.read(pin_switch_sel_mode)==0 then wait_count=0;lighton=0;step=0;tmr.alarm(0,500,1,function()wait_count=wait_count+1;if step==0 then local a=wifi.sta.getip()if a==nil then if lighton==0 then gpio.write(pin_ap_led,gpio.LOW)lighton=1 else gpio.write(pin_ap_led,gpio.HIGH)lighton=0 end;if wait_count>20 then print('emode')tmr.stop(0)gpio.write(pin_ap_led,gpio.LOW)gpio.write(pin_connection_led,gpio.HIGH)step=100;tmr.alarm(0,1000,0,startup)end else step=1;print('con.ok'..a)dofile('app.lua')end elseif step==1 then tmr.stop(0)if cfg~=nil then wifi.sta.setip(cfg)end;gpio.write(pin_ap_led,gpio.LOW)start_configServer(1471)wifi2UartStart(1470)step=100 end end)else print('dmode')gpio.write(pin_ap_led,gpio.LOW)gpio.write(pin_connection_led,gpio.HIGH)start_configServer(1471)end end;startup()",
                        callback : {
                            success : function(data) {

                                var json_data = JSON.parse(data);

                                console.log(data);

                                if(json_data.result == 'ok')
                                {
                                    console.log('success save init.lua')
                                    next(null);
                                }
                                else {
                                    next('error init.lua');
                                }

                            },
                            error : function(err) {

                                next(err);
                            }
                        }
                    });

                },
                function(next) {
                    _upload({

                        filename : 'gpio.lua',
                        content : "new_gpio={[0]=3,[1]=10,[2]=4,[3]=9,[4]=2,[5]=1,[10]=12,[12]=6,[13]=7,[14]=5,[15]=8,[16]=0}pin_ap_led=new_gpio[4]pin_connection_led=new_gpio[5]softuart_tx_pin=new_gpio[12]pin_switch_sel_mode=new_gpio[14]gpio.mode(pin_ap_led,gpio.OUTPUT)gpio.mode(pin_connection_led,gpio.OUTPUT)gpio.mode(softuart_tx_pin,gpio.OUTPUT)gpio.mode(pin_switch_sel_mode,gpio.INPUT)gpio.write(pin_ap_led,gpio.LOW)gpio.write(pin_connection_led,gpio.LOW)",
                        callback : {
                            success : function(data) {

                                var json_data = JSON.parse(data);

                                console.log(data);
                                //next(null);

                                if(json_data.result == 'ok')
                                {
                                    console.log('success save gpio.lua')
                                    next(null);
                                }
                                else {
                                    next('error gpio.lua');
                                }

                            },
                            error : function(err) {

                                next(err);
                            }
                        }
                    });

                },
            function(next) {
                _upload({

                    filename : 'app.lua',
                    content : "function wifi2UartStart(a)uart.setup(0,115200,8,0,1,0)sv=net.createServer(net.TCP,30)global_c=nil;sv:listen(a,function(b)if global_c~=nil then global_c:close()end;global_c=b;gpio.write(pin_connection_led,gpio.HIGH)b:on('receive',function(c,d)softuart.write(softuart_tx_pin,115200,d)end)b:on('disconnection',function(c,d)gpio.write(pin_connection_led,gpio.LOW)global_c=nil end)end)uart.on('data',0,function(e)if global_c~=nil then global_c:send(e)end end,0)end",
                    callback : {
                        success : function(data) {

                            var json_data = JSON.parse(data);

                            console.log(data);
                            //next(null);

                            if(json_data.result == 'ok')
                            {
                                console.log('success save app.lua')
                                next(null);
                            }
                            else {
                                next('error app.lua');
                            }

                        },
                        error : function(err) {

                            next(err);
                        }
                    }
                });

            },
            function(next) {
                _upload({

                    filename : 'u2u.lua',
                    content : "function start_configServer(a)s=net.createServer(net.UDP)cc_udp_socket=nil;s:on('receive',function(s,b)local c=cjson.decode(b)cc_udp_socket=s;rt={}rt.result='ok'rt.id=0;if c.id then rt.id=c.id end;if c.cmd=='ping'then rt.mac=wifi.sta.getmac()elseif c.cmd=='save'then file.open(c.name,'w')file.write(c.content)file.close()elseif c.cmd=='reboot'then tmr.alarm(0,1000,1,function()node.restart()end)else rt.result='nocmd'end;s:send(cjson.encode(rt))end)s:listen(a)end",
                    callback : {
                        success : function(data) {

                            var json_data = JSON.parse(data);

                            console.log(data);
                            //next(null);

                            if(json_data.result == 'ok')
                            {
                                console.log('success save u2u.lua')
                                next(null);
                            }
                            else {
                                next('error u2u.lua');
                            }

                        },
                        error : function(err) {

                            next(err);
                        }
                    }
                });

            }

        ],function(err,robj) {

            if(err) {

                console.log(err)

            }
            else {
                console.log('success all');
            }
        });



    });

    document.querySelector('#wifi-info button.scan').addEventListener('click',function() {


        if(theApp.nowScan == true) {

            if(confirm('스캔을 중지하시겠습니까?')) {
                theApp.nowScan = false;
            }
            else {

            }

        }
        else {

            document.querySelector('#wifi-info .device-list').innerHTML = '';

            theApp.nowScan = true;

            var start_ip = document.querySelector('#wifi-info input.search-start').value;

            if(start_ip == undefined) {
                start_ip = 20;
                document.querySelector('#wifi-info input.search-start').value = 20;

            }

            localStorage.start_ip = start_ip;

            _loop(start_ip);
        }

        function _loop(address) {

            var target_ip = "192.168.9." + address;

            document.querySelector('#wifi-info span.text').innerText = 'scanning.... ' + target_ip;

            if(theApp.nowScan == true) {
                sendPing({
                    timeout : 500,
                    ip : {
                        broker : theApp.broker_ip,
                        target : target_ip
                    },
                    callback : {
                        success : function(data) {

                            var json_data = JSON.parse(data);

                            //디바이스 추가
                            if(json_data.result == 'ok') {
                                console.log('success find :' + address );
                                document.querySelector('#wifi-info input.ip').value = target_ip;
                                document.querySelector('#wifi-info span.text').innerText = 'find ' + target_ip + "(" + json_data.mac  + ")";

                                var em = document.createElement('li');
                                em.innerText = target_ip + "(" + json_data.mac  + ")";
                                em.mydata = {
                                    ip : target_ip,
                                    mac: json_data.mac
                                }

                                em.classList.add('item-device');

                                document.querySelector('#wifi-info .device-list').appendChild(em);
                            }

                            address++;
                            if(address < 250) {
                                _loop(address)
                            }
                            else {
                                //스캔끝~
                                theApp.nowScan = false;
                            }
                        },
                        error : function(err) {

                            console.log('failed at :' + address)
                            address++;

                            if(address < 250) {
                                _loop(address)
                            }
                        }
                    }
                });

            }
        }
    });
    ///////////////

    document.querySelector('#wifi-info ul.device-list').addEventListener('click',function(evt) {

        console.log(evt);

        if(evt.target.classList.contains('item-device') == true) {
            document.querySelector('#wifi-info input.ip').value = evt.target.mydata.ip;
        }

    });


</script>


</body>
</html>