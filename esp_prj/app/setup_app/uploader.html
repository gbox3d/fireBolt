<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title> wifi uploader v0.1.0 </title>

    <script src="libs/extra/async.js"></script>
    <script src="libs/jquery-2.0.3.min.js" ></script>

    <style>

        .frame {
            margin-top: 20px;
            border: 1px solid black;
            padding: 5px;
            background-color: #eec981;
        }

        #admin-cmd div span {
            width: 100px;
            display: inline-block;
        }

    </style>

</head>
<body>

<div>

    <div id="admin-cmd" class="frame">

        <div class="broker-config" >
            <span>broker ip : </span><input class="ip-address" >
        </div>

        <div class="reboot" style="height: 32px;" >
            <button > restart </button>
        </div>

        <div class="ping" style="height: 32px;" >
            <button > ping </button>
        </div>

        <div class="upload" style="height: 32px;" >
            <div>
                file name : <input class="file-name" >
                <textarea class="data" ></textarea>
            </div>
            <div>
                ip :<input class="ip-address" >
                <button > upgrade </button>
            </div>

        </div>

    </div>



</div>

<div id="wnd-log">

</div>


<script>

    var theApp = {
        //broker_ip : "192.168.9.177:1480"
        broker_ip : "localhost:1480"
    }


    if(localStorage.target_ip == undefined) {

        document.querySelector('.upload .ip-address').value='192.168.9.20';

    }
    else {
        document.querySelector('.upload .ip-address').value = localStorage.target_ip;

    }

    if(localStorage.broker_ip_address == undefined) {

        document.querySelector('.broker-config .ip-address').value = localStorage.broker_ip_address = theApp.broker_ip;
    }
    else {

        document.querySelector('.broker-config .ip-address').value = localStorage.broker_ip_address;

    }


    document.querySelector('.broker-config .ip-address').addEventListener('input',function(evt) {

        console.log(evt);

        theApp.broker_ip = localStorage.broker_ip_address = evt.target.value;


    })


    function add_log(msg) {

        var dom_log = document.querySelector('#wnd-log');
        var text = document.createElement('div');
        text.innerText = msg;
        dom_log.appendChild(text);

        setTimeout(function() {
            dom_log.removeChild(text);
        },1000);
    }

    document.querySelector('#admin-cmd .reboot button').addEventListener('click',function() {

        var cuurent_url = theApp.broker_ip;
        //var target_ip = document.querySelector('#wifi-info input.ip').value;
        var target_ip = document.querySelector('#admin-cmd .upload .ip-address').value;

        var udp_requst = {
            address :target_ip,
            port : 1471,
            timeout : 1500,
            packet : {
                id : (new Date()).getTime() + '__',
                cmd:'reboot'
            }
        }
        console.log(udp_requst);

        $.ajax({

            url : 'http://'+ cuurent_url +'/send',
            type:'POST',
            dataType : 'text',
            timeout : 3000,
            data : JSON.stringify( udp_requst),
            success : function(data,text,xhr) {

                console.log(data);

                var json_data = JSON.parse(data);

                if(json_data.result == 'ok') {
                    add_log('reboot cmd send success')
                }
                else {

                    add_log(json_data.result);
                }
            },
            error : function(xhr,text,err) {

            },
            complete : function(xhr,text) {

            }

        });
    });


    function sendPing(option) {

        var cuurent_url = option.ip.broker;//theApp.broker_ip;
        var target_ip = option.ip.target;//document.querySelector('#wifi-info input.ip').value;

        var timeout = 1500;
        if(option.timeout != undefined) {
            timeout = option.timeout;
        }


        var udp_requst = {
            address :target_ip,
            port : 1471,
            timeout : timeout,
            packet : {
                id : (new Date()).getTime() + '__',
                cmd:'ping'
            }
        }
        console.log(udp_requst);

        $.ajax({
            url : 'http://'+ cuurent_url +'/send',
            type:'POST',
            dataType : 'text',
            timeout : 3000,
            data : JSON.stringify( udp_requst),
            success : function(data,text,xhr) {

                console.log(data);

                option.callback.success(data);


            },
            error : function(xhr,text,err) {

                option.callback.error(err);

            },
            complete : function(xhr,text) {

            }
        });

    }

    document.querySelector('#admin-cmd .ping button').addEventListener('click',function() {

        var target_ip = document.querySelector('#admin-cmd .upload .ip-address').value;

        sendPing({
            ip : {
                broker : theApp.broker_ip,
                target : target_ip
            },
            callback : {
                success : function(data) {

                    var json_data = JSON.parse(data);

                    if(json_data.result == 'ok') {
                        add_log('ping cmd send success')
                    }
                    else {

                        add_log(json_data.result);
                    }
                },
                error : function(err) {

                }
            }
        });


    });

    document.querySelector('#admin-cmd .upload button').addEventListener('click',function() {

        var target_ip = document.querySelector('#admin-cmd .upload .ip-address').value;
        localStorage.target_ip = target_ip;
        var cuurent_url = theApp.broker_ip;

        function _upload(option) {

            var udp_requst = {
                address :target_ip,
                port : 1471,
                timeout : 5000,
                packet : {
                    id : (new Date()).getTime() + '__',
                    cmd:'save',
                    name:option.filename,
                    content : option.content
                }
            }

            console.log(udp_requst);

            $.ajax({

                url : 'http://'+ cuurent_url +'/send',
                type:'POST',
                dataType : 'text',
                timeout : 5000,
                data : JSON.stringify( udp_requst),
                success : function(data,text,xhr) {

                    console.log(data);

                    option.callback.success(data);

                    /*
                     var json_data = JSON.parse(data);

                     if(json_data.result == 'ok') {
                     add_log('app.lua file save success')
                     }
                     else {

                     add_log(json_data.result);
                     }*/
                },
                error : function(xhr,text,err) {
                    option.callback.error(err);

                },
                complete : function(xhr,text) {
                    // option.callback.complete(data);
                }

            });
        }

        async.waterfall([

            function(next) {

                var filename = document.querySelector('#admin-cmd .upload .file-name').value;
                var filedata = document.querySelector('#admin-cmd .upload .data').value;

                _upload({

                    filename : filename,
                    content : filedata,
                    callback : {
                        success : function(data) {

                            var json_data = JSON.parse(data);

                            console.log(data);

                            if(json_data.result == 'ok')
                            {
                                console.log('success save ' + filename);
                                add_log('success save ' + filename);
                                next(null);
                            }
                            else {
                                //next('error :' + filename);
                                add_log(json_data.result)
                            }

                        },
                        error : function(err) {

                            next(err);
                        }
                    }
                });

            }
        ],function(err,robj) {

            if(err) {

                console.log(err)

            }
            else {
                console.log('success all');
            }
        });



    });



</script>


</body>
</html>